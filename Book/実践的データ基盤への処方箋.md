# 実践的データ基盤への処方箋

## はじめに
* Pocだけであればデータアナリスト、データサイエンティストだけで十分だが、<br>
  真のデータ活用とは、一時的ではなく継続的に企業の成長を支えること
* データ基盤のつくり方は認知されてきたが、活用のさせ方が認知されていない

## 第1章 データ活用のためのデータ整備
### データソース
* 自社のデータの流れをCRUD表などで整理
  * どのようにデータ整備が必要なのか分かる
  * 影響調査などに使える
  * 同時に用語集をまとめる
  * より詳細に把握するためにはER図などで可視化
* 業務レイヤを整理
  * テーマごとに下記の観点でまとめて業務の流れにおけるボトルネックを把握する
    * ロール　　　　　：対象者・物
    * オペレーション　：操作
    * アプリケーション：インターフェース
    * ストレージ　　　：格納先
* データ生成の現場を考える
  * ステークホルダー間の利害が発生する
    * 営業とアナリストなど
  * 利害を調整し解決するためには
    1. 課題に気づく
      * 部門間の定期的なフィードバックにより課題に気づく
    2. 解決したいと思える
      * それをやる意味やインセンティブ設計を見直す
    3. 簡単に解決できる
      * データ生成におけるUXを整える
* データソース整備
  * マスタ：表記揺れを防ぐための辞書
  * 共通ID：商品などのID
  * 履歴　：レコードがUPDATEされないようにする

### データレイク
* データレイクで生じる問題
  * 生データではなくクレンジングされたデータが格納される
  * 複数箇所にデータレイクが存在する

### データウェアハウス
* 対象のデータを共通指標を元に意味ある形で格納する
* どのように作るか
  1. データクレンジング
  2. スタースキーマの作成
    * ファクトテーブル
      * 基準となるデータ
      * 1つもしくは少数のファクト
    * ディメンションテーブル
      * ファクトから派生した各属性ごとの詳細データ
      * 複数のディメンション
  3. 共通指標の集計
* 初期段階ではデータウェアハウスを作らない
  * 共通指標が分からない状況の中で作成しても使われるものにならない
  * データマートが活用されるようになった後で共通指標の集計を行う
  * それまではデータマートはデータレイクを直接参照する形で作成する

### データマート
* 用途（ユースケース）と一対一の関係にある
* データマートで生じる問題
  * データマート層の肥大化
    * 役目を終えたものや、重複したものなど
    * 利用状況などから定期的に棚卸しを行う
  * BIツールをデータマートとして利用していると集計ロジックが分散する
    * 対策
      1. アナリストがBIツールや表計算ソフトで集計ロジックを模索
      2. 確立したロジックをデータマートそのものに反映する

### ユースケース
* ユースケースの便益以上に開発や運用に手間をかけてはいけない
* 思考の9割をユースケースに向ける
  * 「解くべき課題」に対してアプローチできているか
    * 要件の策定・調整
    * 利用状況のモニタリング

### メタデータ
* メタデータに関しても最初はミニマムで進めること
  * カラムディスクリプションを充実させるなど

### サービスレベル
* サービス品質を改善するには
  * システムではなくサービスに注目すること
    * 目線がシステムだと、利用者を置き去りにしたKPIなどになってしまう
  * 計測すること
    * 計測を行なっていないと課題すら生まれない
* サービス品質設計
  * ユースケースに応じたサービスレベルの設計

### データスチュワード（データマネージャー・アナリティクスエンジニア）
* 役割
  * データ活用者にとっての相談窓口
    * 問い合わせにより課題を検知する
  * データ整備の推進者
    * ボトムアップでの課題に対しての改善策を立案・推進
      * お問い合わせ等
    * トップダウンでの課題に対しての改善策を立案・推進
      * 組織の目標など

## 第2章 データ基盤システムのつくり方
### データ収集
* ファイル
  * ファイルを配置するシステムとは別に、配置の完了を通知する仕組み（トリガー）を用意する
    * 書き込み途中のファイルを収集してしまう可能性
  * ファイル形式
    * AVRO
      * JSONより厳密なデータ構造
    * Parquet
      * 列志向形式
        * 圧縮に優れている
* API
  * RateLimitsやAPIキーの失効に注意する
* SQL
  * 選択肢
    * カーソル
    * レプリカ
    * エクスポート
      * S3などにCSV,JSON形式でエクスポート
      * ワークフローエンジンなどを利用
    * ダンプファイル
      * DBを立て直す必要があるためコストもかかる
    * 更新ログの収集
      * どんな操作を行ったかを収集して、同じように適用する
      * CDCツール
        * 具体例
          * AWS Database Migration Service
          * GCP Datastream
  * 選択
    * よく採用される
      * レプリカ
    * ミニマムで始める場合
      * 直でSQL
    * 負荷を与えたくない場合
      * エクスポート
      * ダンプ
      * CDCツール
* ログ
  * 例
    * Webサーバーのアクセスログ
    * アプリケーションのログ
      * 充実しているとDBからデータを参照する必要がなくなる可能性も
  * ログ収集エージェント
    * fluentd
    * fluent-bit
    * AWS CloudWatch
    * GCP Cloud Logging Agent
### ETL
* 利用予定のコネクタの機能に注目
* デバッグしやすいもの

### データレイク
* 現在はデータレイクにもデータウェアハウスと同じ分析用DBを利用する方式が流行ってきた
* データソースがオンプレミスにあってもデータレイクはクラウドにする

### データウェアハウス
* DBの種類
  * オペレーショナルDB
    * レコード単位での操作が速い
  * 分析用DB
    * カラム単位での操作が速い
    * 種類
      * Hadoopベース
        * AWS Athena
        * GCP Dataproc
        * Treasure Data
      * DWH製品
        * BigQuery
        * Redshift
        * Snowflake
    * 列志向圧縮
      * UPDATEが苦手
        * UPDATEを行う場合は一度テーブルをDROPして再作成するなど
      * 1件ずつINSERTではなく、複数件をロードする

### ワークフローエンジン
* サービス
  * Airflow
    * GCP
      * Cloud Composer
    * AWS
      * Amazon Managed Workflows for Apache Airflow


## 第3章 データ基盤を支える組織


## 思ったこと
* デジタルマーケティンやセールスイネーブルメントとの繋がりが密接なので、知見を広げる先はかなり広い
* アプリのエンジニアに関わらず、データエンジニアにおいても、あくまで手段に過ぎず、「ユースケース」に目を向けることが何よりも重要
